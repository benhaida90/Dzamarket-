# ๐งช ุฏููู ุงุฎุชุจุงุฑ flow ุงูุดุฑุงุก ุงููุงูู - DzaMarket

## ูุธุฑุฉ ุนุงูุฉ
ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุงุฎุชุจุงุฑ ุนูููุฉ ุงูุดุฑุงุก ุงููุงููุฉ ูู ุงูุจุฏุงูุฉ ููููุงูุฉ.

---

## ๐ ุญุณุงุจุงุช ุงูุงุฎุชุจุงุฑ

ุชู ุฅูุดุงุก 3 ุญุณุงุจุงุช ุงุฎุชุจุงุฑ ุฌุงูุฒุฉ:

### 1. ุงูุจุงุฆุน (Seller)
- **Email:** ahmed@test.dz
- **Password:** password123
- **Role:** ุจุงุฆุน ุนุงุฏู
- **Products:** 3 ููุชุฌุงุช

### 2. ุงููุดุชุฑู (Buyer) 
- **Email:** fatima@test.dz
- **Password:** password123
- **Role:** ูุดุชุฑู
- **Products:** 0 ููุชุฌุงุช

### 3. ุงูุจุงุฆุน ุงููููุฒ (Premium Seller)
- **Email:** karim@test.dz
- **Password:** password123
- **Role:** ุจุงุฆุน ูููุฒ (Premium)
- **Products:** 2 ููุชุฌุงุช

---

## ๐ ุฎุทูุงุช ุงุฎุชุจุงุฑ flow ุงูุดุฑุงุก

### **ุงูุฎุทูุฉ 1: ุชุณุฌูู ุงูุฏุฎูู ููุดุชุฑู**

1. ุงูุชุญ: http://localhost:3000/login
2. ุฃุฏุฎู ุงูุจูุงูุงุช:
   - Email: `fatima@test.dz`
   - Password: `password123`
3. ุงุถุบุท "ุชุณุฌูู ุงูุฏุฎูู"

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุชุญูููู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุน ุนุฑุถ ุงูููุชุฌุงุช

---

### **ุงูุฎุทูุฉ 2: ุชุตูุญ ุงูููุชุฌุงุช**

1. ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉุ ุณุชุฌุฏ 5 ููุชุฌุงุช:
   - Samsung Galaxy S24 Ultra (180,000 DZD)
   - Renault Clio 2020 (2,500,000 DZD)
   - ุดูุฉ 3 ุบุฑู (45,000 DZD)
   - ุทุงููุฉ ุทุนุงู (85,000 DZD)
   - ุฎุฑูู ุงูุนูุฏ (75,000 DZD)

2. ุฌุฑูุจ:
   - ุงูุถุบุท ุนูู ุงูููุจ (Like) โค๏ธ
   - ุงูุถุบุท ุนูู ุงูุชุนูููุงุช ๐ฌ
   - ุงูููุชุฑุฉ ุญุณุจ ุงููุฆุงุช

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุงูุชูุงุนูุงุช ุชุนูู

---

### **ุงูุฎุทูุฉ 3: ุนุฑุถ ุชูุงุตูู ุงูููุชุฌ**

1. ุงุถุบุท ุนูู ุฃู ููุชุฌ (ูุซูุงู Samsung Galaxy S24 Ultra)
2. ุณุชูุชุญ ุตูุญุฉ ุงูุชูุงุตูู ุชุนุฑุถ:
   - ุตูุฑ ุงูููุชุฌ
   - ุงูุณุนุฑ ูุงููุตู
   - ูุนูููุงุช ุงูุจุงุฆุน
   - ูุธุงู ุงูุถูุงู (Escrow)
   - ุงูุชุนูููุงุช

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูู ุงููุนูููุงุช ุชุธูุฑ ุจุดูู ุตุญูุญ

---

### **ุงูุฎุทูุฉ 4: ุจุฏุก ุนูููุฉ ุงูุดุฑุงุก**

1. ูู ุตูุญุฉ ุชูุงุตูู ุงูููุชุฌ
2. ุงุถุบุท ุฒุฑ "ุงุดุชุฑู ุงูุขู" ุงูุฃุฎุถุฑ
3. ุณูุธูุฑ toast notification: "ุชู ุจุฏุก ุนูููุฉ ุงูุดุฑุงุก ุจูุธุงู ุงูุถูุงู"

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฅุดุนุงุฑ ุงููุฌุงุญ + ุฅูุดุงุก transaction ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### **ุงูุฎุทูุฉ 5: ูุญุงูุงุฉ ุงูุฏูุน (Mock Payment)**

**ููุงุญุธุฉ:** ูุธุงู ุงูุฏูุน ุญุงููุงู **ูููู (mock)** ูุฃุบุฑุงุถ ุงูุงุฎุชุจุงุฑ.

ูู ุงูุฅูุชุงุฌ ุงููุนููุ ุณูุชู:
1. ุฅุนุงุฏุฉ ุชูุฌููู ูุจูุงุจุฉ ุงูุฏูุน (CIB/SATIM)
2. ุฅุฏุฎุงู ุจูุงูุงุช ุงูุจุทุงูุฉ
3. ุชุฃููุฏ ุงูุฏูุน
4. ุงูุนูุฏุฉ ูููููุน

**ููุงุฎุชุจุงุฑ ุงูุญุงูู:**
- ุงูู transaction ูููุดุฃ ูุจุงุดุฑุฉ ุจุญุงูุฉ `in_escrow`
- ูุง ุญุงุฌุฉ ููุฏูุน ุงููุนูู

---

### **ุงูุฎุทูุฉ 6: ุงูุชุญูู ูู Transaction**

#### **A. ุจุงุณุชุฎุฏุงู MongoDB (Backend)**

```bash
cd /app/backend
python3 -c "
from motor.motor_asyncio import AsyncIOMotorClient
import asyncio
import os

async def check():
    client = AsyncIOMotorClient(os.environ['MONGO_URL'])
    db = client[os.environ['DB_NAME']]
    
    # Get latest transaction
    tx = await db.transactions.find_one(
        sort=[('created_at', -1)]
    )
    
    if tx:
        print(f'Transaction ID: {tx[\"id\"]}')
        print(f'Status: {tx[\"status\"]}')
        print(f'Amount: {tx[\"amount\"]} DZD')
        print(f'Buyer: {tx[\"buyer_id\"]}')
        print(f'Seller: {tx[\"seller_id\"]}')
    else:
        print('No transactions found')

asyncio.run(check())
"
```

#### **B. ุจุงุณุชุฎุฏุงู API**

```bash
# ุงุญุตู ุนูู token ุฃููุงู ูู login
TOKEN="your_jwt_token_here"

# ุนุฑุถ ุงููุนุงููุงุช
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8001/api/payments/transactions
```

---

### **ุงูุฎุทูุฉ 7: ุชุฃููุฏ ุงุณุชูุงู ุงูููุชุฌ**

1. ุงุฐูุจ ุฅูู ููุญุฉ ุงูุชุญูู: http://localhost:3000/dashboard
2. ุงุถุบุท ุนูู ุชุจููุจ "ุงููุนุงููุงุช"
3. ุณุชุฌุฏ ุงููุนุงููุฉ ุจุญุงูุฉ "ูู ุงูุถูุงู"
4. ุงุถุบุท ุฒุฑ "ุชุฃููุฏ ุงูุงุณุชูุงู"

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- ุชุบููุฑ ุญุงูุฉ Transaction ุฅูู `completed`
- ุฅุทูุงู ุงูุฃููุงู ููุจุงุฆุน
- ุญุณุงุจ ุงูุนูููุงุช (2%)
- ุญุณุงุจ ุฃุฑุจุงุญ ุงูุฅุญุงูุฉ (ุฅู ููุฌุฏุช)

---

### **ุงูุฎุทูุฉ 8: ุงูุชุญูู ูู ูุธุงู ุงูุฅุญุงูุฉ**

1. ูู Dashboard
2. ุงุถุบุท ุนูู ุชุจููุจ "ูุธุงู ุงูุฅุญุงูุฉ"
3. ุณุชุฌุฏ:
   - ุฑูุฒ ุงูุฅุญุงูุฉ ุงูุฎุงุต ุจู
   - ุนุฏุฏ ุงูุฅุญุงูุงุช (Level 1 & 2)
   - ุงูุฃุฑุจุงุญ ูู ุงูุฅุญุงูุงุช

**ูุงุฎุชุจุงุฑ ูุธุงู ุงูุฅุญุงูุฉ:**

1. ุงูุณุฎ ุฑูุฒ ุงูุฅุญุงูุฉ (ูุซูุงู: FATIMA2025)
2. ุณุฌูู ุฎุฑูุฌ
3. ุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ ุจุงุณุชุฎุฏุงู ููุฏ ุงูุฅุญุงูุฉ
4. ุนูุฏ ุดุฑุงุก ุงููุณุชุฎุฏู ุงูุฌุฏูุฏุ ุณุชุญุตู ุนูู 0.25%

---

## ๐งช ุงุฎุชุจุงุฑ API ูุจุงุดุฑุฉ

### **1. ุฅูุดุงุก Escrow Payment**

```bash
# Login ุฃููุงู
curl -X POST http://localhost:8001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "fatima@test.dz",
    "password": "password123"
  }'

# ุงุญูุธ ุงูู token
TOKEN="<token_from_above>"

# ุงุญุตู ุนูู product ID ูู ุงูููุชุฌุงุช
curl http://localhost:8001/api/products | jq '.data.items[0].id'

PRODUCT_ID="<product_id>"

# ุฅูุดุงุก ุนูููุฉ ุดุฑุงุก
curl -X POST http://localhost:8001/api/payments/create-escrow \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"product_id\": \"$PRODUCT_ID\",
    \"payment_method\": \"CIB\"
  }"
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** JSON response ูุน `escrowId` ู `paymentUrl`

---

### **2. ุชุฃููุฏ ุงุณุชูุงู ุงูููุชุฌ**

```bash
# ุงุณุชุฎุฏู escrowId ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ
ESCROW_ID="<escrow_id>"

curl -X POST http://localhost:8001/api/payments/confirm-delivery \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"transaction_id\": \"$ESCROW_ID\",
    \"confirmed\": true
  }"
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฑุณุงูุฉ ูุฌุงุญ + ุชุญุฏูุซ ุญุงูุฉ Transaction

---

### **3. ุงูุชุญูู ูู ุฃุฑุจุงุญ ุงูุฅุญุงูุฉ**

```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8001/api/payments/referral-earnings | jq
```

---

## ๐ ุงูุญุงูุงุช ุงููุชููุนุฉ ููู Transaction

| ุงูุญุงูุฉ | ุงููุตู | ุงููุฑุญูุฉ |
|--------|-------|---------|
| `pending` | ุชู ุฅูุดุงุก ุงูุทูุจุ ุจุงูุชุธุงุฑ ุงูุฏูุน | 1 |
| `in_escrow` | ุชู ุงูุฏูุนุ ุงูุฃููุงู ูุญููุธุฉ | 2 |
| `completed` | ุชู ุงูุชุฃููุฏุ ุงูุฃููุงู ุฃูุทููุช | 3 |
| `cancelled` | ุฃูุบูุช ุงููุนุงููุฉ | X |

---

## ๐ ุงููุดุงูู ุงูุดุงุฆุนุฉ ูุญููููุง

### **ุงููุดููุฉ 1: "Product not found"**
**ุงูุญู:** ุชุฃูุฏ ูู ุฃู seed_data.py ุชู ุชุดุบููู
```bash
cd /app/backend && python seed_data.py
```

---

### **ุงููุดููุฉ 2: "Cannot purchase your own product"**
**ุงูุญู:** ุณุฌูู ุฏุฎูู ููุดุชุฑู (fatima@test.dz)ุ ูููุณ ูุจุงุฆุน

---

### **ุงููุดููุฉ 3: "Transaction not found"**
**ุงูุญู:** ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู transaction_id ุงูุตุญูุญ ูู Response

---

### **ุงููุดููุฉ 4: Token expired**
**ุงูุญู:** ุณุฌูู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู ููุญุตูู ุนูู token ุฌุฏูุฏ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ูุธุงู ุงูุฏูุน Mock:** ุงูุฏูุน ุงูุญุงูู ูููู. ูุชูุนูู ุงูุฏูุน ุงูุญููููุ ุฑุงุฌุน `/app/PAYMENT_INTEGRATION_GUIDE.md`

2. **ุงูุนูููุงุช:** ุงูููุตุฉ ุชุฃุฎุฐ 2% ูู ูู ูุนุงููุฉ (1% ูู ุงููุดุชุฑู + 1% ูู ุงูุจุงุฆุน)

3. **ูุธุงู ุงูุฅุญุงูุฉ:**
   - Level 1: 0.25% ูู ูุนุงููุงุช ุงููุญุงููู ูุจุงุดุฑุฉ
   - Level 2: 0.25% ูู ูุนุงููุงุช ูุญุงูู ุงููุญุงููู

4. **Escrow Protection:** ุงูุฃููุงู ูุง ุชูุทูู ููุจุงุฆุน ุฅูุง ุจุนุฏ ุชุฃููุฏ ุงููุดุชุฑู

---

## ๐ฏ Checklist ุงูุงุฎุชุจุงุฑ ุงููุงูู

- [ ] ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
- [ ] ุนุฑุถ ุงูููุชุฌุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุชุตูุญ ุชูุงุตูู ููุชุฌ
- [ ] ุงูุถุบุท ุนูู "ุงุดุชุฑู ุงูุขู"
- [ ] ุฅูุดุงุก transaction ุจุญุงูุฉ `in_escrow`
- [ ] ุนุฑุถ ุงููุนุงููุงุช ูู Dashboard
- [ ] ุชุฃููุฏ ุงุณุชูุงู ุงูููุชุฌ
- [ ] ุชุญุฏูุซ ุญุงูุฉ Transaction ุฅูู `completed`
- [ ] ุญุณุงุจ ุงูุนูููุงุช ุตุญูุญ
- [ ] ูุธุงู ุงูุฅุญุงูุฉ ูุนูู

---

**ุฌุงูุฒ ููุงุฎุชุจุงุฑ! ๐**

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงููุ ุฑุงุฌุน logs:
```bash
# Backend logs
tail -f /var/log/supervisor/backend.err.log

# Frontend logs  
tail -f /var/log/supervisor/frontend.err.log
```
